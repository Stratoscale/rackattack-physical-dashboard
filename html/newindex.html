{% extends "base.html" %}

{% block head %}

<script>
</script>

{% block head_more %}
<link href="/static/style.css" rel="stylesheet">
<link href="/static/darktheme.css" rel="stylesheet" id="dark">
<link href="/static/lighttheme.css" rel="stylesheet" id="light">
<script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
<script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
<script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
<script src="https://unpkg.com/remarkable@1.6.2/dist/remarkable.min.js"></script>
<script type="text/javascript" src="/realtimewebui/js/realtimewebui.js"></script>
<script type="text/javascript" src="/realtimewebui/externals/underscore-min.js"></script>
<script>
var globalModelWebsocketPort = {{globalModelWebsocketPort}};
var globalModelWebsocketSecret = "{{globalModelWebsocketSecret}}";
</script>
{% endblock %}

<script type="text/babel">
var nrHostsPerRow = 2;

var rackattackInstances = [
{% for dashboardSource in dashboardSources %}
{name: "{{ dashboardSource.name }}", host: "{{ dashboardSource.host }}"},
{% endfor %}
]
var activeDashboardName = "";
var activeDashboardHost = "";
var ui = new RealTimeWebUI();

function pad(str) {
    str = str.toString();
    var pad = "00"
    var ans = pad.substring(0, pad.length - str.length) + str
    return ans;
}

var DashboardContent = React.createClass({
  render: function() {
    return (
      <div className="row">
        <section className="col-md-6">
          <RackList hosts={this.props.hosts} />
        </section>
        <aside className="col-md-6">
            <DashboardPanelGroup allocations={this.props.allocations} hosts={this.props.hosts} />
        </aside>
      </div>
    );
  },

});

var RackList = React.createClass({
  getRacksToHosts: function(hosts) {
    return _.groupBy(hosts, function(host) {
      var rackNumber = parseInt(host.id.replace("rack", "").replace("-server\d", ""));
      return rackNumber;
    });
  },

  getNrSlotsInASingleRack: function(racksToHosts) {
    var nrHostsPerRack = _.map(_.values(racksToHosts), function(hosts) {
      return hosts.length;
    });
    return _.max(nrHostsPerRack);
  },

  getOrderedRacks: function(hosts) {
    var racksToHosts = this.getRacksToHosts(hosts);
    var racksNumbers = Object.keys(racksToHosts);
    var orderedRacksIDs = _.sortBy(racksNumbers, function(number) {
        return number;
    });
    var nrSlots = this.getNrSlotsInASingleRack(racksToHosts);
    return _.map(orderedRacksIDs, function(rackID) {
        return (
            <Rack id={rackID} key={rackID} hosts={racksToHosts[rackID]} nrSlots={nrSlots} />
        );
    });
  },

  render: function() {
	var racks = this.getOrderedRacks(this.props.hosts);
    return (
      <div className="rackList">
        {racks}
      </div>
    );
  }
});

var Rack = React.createClass({
  getRackRows: function(hosts) {
    hosts = _.indexBy(hosts, "id");
    var nrRows = Math.ceil(this.props.nrSlots / nrHostsPerRow);
    var rackID = "rack" + pad(this.props.id);
    var rows = _.map(_.range(nrRows), function(rowNumber) {
        var idxOfFirstHostInRow = 1 + rowNumber * nrHostsPerRow;
        var rowHostsIndices = _.range(idxOfFirstHostInRow, idxOfFirstHostInRow + nrHostsPerRow);
        var rowHosts = _.map(rowHostsIndices, function(hostIdx) {
            var hostID = rackID + "-server" + pad(hostIdx);
            if (hostID in hosts) {
                return <Host data={hosts[hostID]} key={hostID} hostIdx={hostIdx} />
            }
            return <EmptyHostSlot hostID={hostID} key={hostID} hostIdx={hostIdx} />
        });
        return <RackRow key={idxOfFirstHostInRow} hosts={rowHosts} />
    });
    return rows;
  },
  render: function() {
    var rackRows = this.getRackRows(this.props.hosts);
    return (
      <div className="rack col-md-4">
        <h2>
          Rack {this.props.id}
        </h2>
        <table className="rack-table">
          <tbody>
            {rackRows}
          </tbody>
        </table>
      </div>
    );
  }
});

var RackRow = React.createClass({
  render: function() {
    return (
      <tr className="rackRow">
       {this.props.hosts}
      </tr>
    );
  }
});

var stateMap = {
    "QUICK_RECLAIMATION_IN_PROGRESS":{ iconClass: "glyphicon-backward", labelClass: "label-info" },
    "SLOW_RECLAIMATION_IN_PROGRESS":{ iconClass: "glyphicon-fast-backward", labelClass: "label-warning" },
    "CHECKED_IN":{ iconClass: "glyphicon-pause", labelClass: "label-primary" },
    "INAUGURATION_LABEL_PROVIDED":{ iconClass: "glyphicon-play", labelClass: "label-info" },
    "INAUGURATION_DONE":{ iconClass: "glyphicon-ok", labelClass: "label-success" },
    "DESTROYED":{ iconClass: "glyphicon-remove", labelClass: "label-danger" },
    "OFFLINE":{ iconClass: "glyphicon-off", labelClass: "label-default-dark" },
    "DETACHED":{ iconClass: "glyphicon-eject", labelClass: "label-detached" }
};
var NAT_ADDR = "rackattack-nat.dc1";

var Host = React.createClass({
  getNatPortFromInnerIPAddress: function(ipAddress) {
        return 2000 + parseInt(ipAddress.split(".")[3]) + (parseInt(ipAddress.split(".")[2]) - 1) * 256;
  },
  generatePopoverContent: function() {
    var content = "Inner: " + this.props.data.ipAddress;
    content += "<br />Outer: " + NAT_ADDR + ":" + this.getNatPortFromInnerIPAddress(this.props.data.ipAddress);
    if (this.props.data.nodeName) {
        content += "<br />Node: " + this.props.data.nodeName;
    }
    content += "<br />Pool: " + this.props.data.pool;
    if (this.props.data.warnings) {
        content += "<br /><span class='text-danger'>Warnings:<ul>";
        for (var idx in this.props.data.warnings) {
            var warning = this.props.data.warnings[idx];
            content += "<li>" + warning + "</li>";
        }
        content += "</ul></span>";
    }
    if (this.props.data.reasonForDestruction) {
        content += "<div class='text-danger'>Reason for destruction: " + this.props.data.reasonForDestruction + "</span>";
    }
    return content;
  },
  componentDidMount: function() {
    var content = this.generatePopoverContent();
    $("#node-" + this.props.data.id).popover({
      title: this.props.data.id,
      container: "body",
      content: content,
      trigger: "hover",
      placement: "auto",
      html: true
    });
  },
  render: function() {
    var labelClassNames = "label machine-label " + stateMap[this.props.data.state]["labelClass"];
    var iconClassNames = "glyphicon " + stateMap[this.props.data.state]["iconClass"];
    var warningSign = "";
    if (this.props.data.warnings) {
      warningSign = (<span className="warningSignWrapper">
          <span className="glyphicon glyphicon-warning-sign">{this.props.data.warnings.length}</span>
      </span>)
    }
    return (
      <td className="host machine" id={"node-"+this.props.data.id}>
        <span className={labelClassNames}>
          <span className={iconClassNames}></span>
            {pad(this.props.hostIdx)}
            {warningSign}
        </span>
      </td>
    );
  }
});

var Stats = React.createClass({
  render: function() {
    return (
            <ul className="list-group">
              <li className="list-group-item">
                <span className="label label-primary">
                  <span className="glyphicon glyphicon-pause">
                  </span>
                  Available
                </span>
                 (checked in) hosts in default pool:
                <span className="badge badge-primary">
                  {this.nrHosts('default', 'CHECKED_IN')}
                </span>
              </li>
              <li className="list-group-item">
                <span className="label label-primary">
                  <span className="glyphicon glyphicon-pause">
                  </span>
                  Available
                </span>
                 (checked in) in non-default pools:
                <span className="badge badge-primary">
                  {this.nrHosts('', 'CHECKED_IN') - this.nrHosts('default', 'CHECKED_IN')}
                </span>
              </li>
              <li className="list-group-item">
                <span className="label label-danger">
                  <span className="glyphicon glyphicon-remove">
                  </span>
                  Destroyed
                </span>
                 hosts:
                <span className="badge badge-danger">
                  {this.nrHosts('', 'DESTROYED')}
                </span>
              </li>
              <li className="list-group-item">
                <span className="label label-default-dark">
                  <span className="glyphicon glyphicon-off">
                  </span>
                  Offline
                </span>
                 hosts:
                <span className="badge badge-dark">
                  {this.nrHosts('', 'OFFLINE')}
                </span>
              </li>
              <li className="list-group-item">
                <span className="label label-success">
                  <span className="glyphicon glyphicon-ok">
                  </span>
                  In-use
                </span>
                 (Inauguration Done) hosts:
                <span className="badge badge-success">
                  {this.nrHosts('', 'INAUGURATION_DONE')}
                </span>
              </li>
              <li className="list-group-item">
                <span className="label label-detached">
                  <span className="glyphicon glyphicon-eject">
                  </span>
                  Detached
                </span>
                hosts:
                <span className="badge badge-detached">
                  {this.nrHosts('', 'DETACHED')}
                </span>
              </li>
              <li className="list-group-item">
                Total Nr. of hosts:
                <span className="badge badge">
                  {this.nrHosts('', '')}
                </span>
              </li>
              <li className="list-group-item">
                Current hosts usage:
                <span className="badge badge">
                  {(((this.nrHosts('', 'INAUGURATION_DONE') + this.nrHosts('', 'DETACHED')) / this.nrHosts('', '')) * 100).toFixed(0).toString() + '%'}
                </span>
              </li>
            </ul>
    );
  },

  nrHosts: function(pool, state) {
    var hosts = this.props.hosts;
    if (hosts === undefined) {
        return 0;
    }
    if (!pool && !state) {
        return hosts.length;
    }
    hosts = _.countBy(hosts, function(host) {
        var condition = host.state == state;
        if (pool) {
            condition = condition && (host.pool == pool);
        }
        return condition;
    })[true];
    if (hosts === undefined) {
        return 0;
    }
    return hosts;
  }
});


var StatesLegend = React.createClass({
  render: function() {
    return (
      <div>
      <p><span className="label label-info"><span className="glyphicon glyphicon-backward"></span> QUICK_RECLAIMATION_IN_PROGRESS</span></p>
      <p>Quick reclaim works using kexecing the inaugurator on the host
      </p>
      <p><span className="label label-warning"><span className="glyphicon glyphicon-fast-backward"></span> SLOW_RECLAIMATION_IN_PROGRESS</span></p>
      <p>
          Slow reclaim works by rebooting the server and using PXE to load the inaugurator.
          This is slow since a server takes minutes to reboot, plus, more than one reboot
          might be required.
      </p>
      <p><span className="label label-primary"><span className="glyphicon glyphicon-pause"></span> CHECKED_IN</span></p>
      <p>
          The inaugurator has booted successfully, and is waiting for the command to switch
          a rootfs. The current rootfs is being hashed in the background.
      </p>
      <p><span className="label label-info"><span className="glyphicon glyphicon-play"></span> INAUGURATION_LABEL_PROVIDED</span></p>
      <p>
          The inaugurator is replacing the rootfs in this host.
      </p>
      <p><span className="label label-success"><span className="glyphicon glyphicon-ok"></span> INAUGURATION_DONE</span></p>
      <p>
          The inaugurator has finished replacing the rootfs. This host was kexeced into
          its image, which if not hung, means the test itself is running.
      </p>
      <p><span className="label label-danger"><span className="glyphicon glyphicon-remove"></span> DESTROYED</span></p>
      <p>
          A temporary stage, on the road for the host to drop out of the cluster. This
          happens if 5 slow reclamations failed on this host
      </p>
      <p><span className="label label-default-dark"><span className="glyphicon glyphicon-off"></span> OFFLINE</span></p>
      <p>
          The server is off.
      </p>
      <p><span className="label label-detached"><span className="glyphicon glyphicon-eject"></span> DETACHED</span></p>
      <p>
          A temporary state which "freezes" the server at the moment it was detached; Rackattack will not shut it off or reclaim it in this state, nor will it be available for allocation. Meant for debugging or one-time-inaugurations.
      </p>
      </div>
    );
  }
});

var AllocationRow = React.createClass({
  render: function() {
    return (
          <tr className="allocation-row" onMouseOver={() => this.showAllocationHosts() }>
            <td>
              <div className="media">
                <a className="media-left pull-left" href="#">
                  <div className="color-swatch">3</div>
                </a>
                <div className="media-body">
                  <div className="media-heading">{this.props.allocation.allocationInfo.user}</div>
                  <ul className="hosts-list list-group">
                    <li className="list-group-item">
                      <span className="host-icon">
                        <span className="glyphicon"></span>
                      </span>
                      <span className="test-name">test name</span> (
                      <span data-bind="text: hostName">
                      </span>)
                      <div className="pull-right copy-command">
                        <span className="glyphicon glyphicon-circle-arrow-right connect-link" >
                        </span>
                      </div>
                      <span className="badge">
                        <span>
                        </span>
                      </span>
                    </li>
                  </ul>
                </div>
              </div>
            </td>
            <td className="state-column">
              <div>
                <span className="label label-danger"> DEAD or DONE or WAIT </span>
              </div>
            </td>
            <td>
              {this.prettyDuration(this.props.allocation.duration)}
            </td>
          </tr>
    );
  },

  prettyDuration: function(duration) {
    var nrSeconds = parseInt(duration);
    var nrMinutes = Math.floor(nrSeconds / 60);
    if (nrMinutes == 0) {
        nrMinutes = 1;
    }
    if (nrMinutes < 60) {
        return nrMinutes + "m";
    }
    var nrHours = Math.floor(nrMinutes / 60);
    if (nrHours < 24) {
        result = nrHours + "h";
        var nrMinutesResidue = nrMinutes % 60;
        if (nrMinutesResidue > 0) {
            result += " " + nrMinutesResidue + "m";
        }
        return result;
    }
    var nrHoursResidue = nrHours % 24;
    var nrDays = Math.floor(nrHours / 24);
    var result = nrDays + "d";
    if (nrHoursResidue > 0) {
        result += " " + nrHoursResidue + "h";
    }
    return result;
  },

  showAllocationHosts: function() {
    console.log('asdasd');
  }
});

var Allocations = React.createClass({
  render: function() {
    console.log(this.props.allocations[0]);
    return (
      <table className="table">
        <thead>
          <tr>
            <th>Allocation</th>
            <th>State</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody>
          {this.props.allocations.map(function(allocation) {
            return <AllocationRow key={allocation.index} allocation={allocation} /> ;
          })}
        </tbody>
      </table>
    );
  }
});

var Pools = React.createClass({
  render: function() {
    return (
        <div>ad</div>
    );
  }
});

var Diagnostics = React.createClass({
  render: function() {
    return (
        <div>ad</div>
    );
  }
});

var Panel = React.createClass({
  componentWillMount: function() {
    this.panelContent = "";
    this.isDoneRenderingByDefault = false;
  },

  render: function() {
    var panelID = this.props.heading + "_Panel";
    var panelBodyClasses = "panel-body";
    if (this.props.noPanelPadding) {
        panelBodyClasses += " panel-body-with-list-group";
    }
    var panelCollapseClasses = "panel-collapse collapse";
    var isPanelActive = this.props.activePanelName == this.props.heading;
    if (this.props.isActiveByDefault && (!this.isDoneRenderingByDefault)) {
        panelCollapseClasses += " in";
    }
    this.panelContent = this.props.children;
    var children;
    if (isPanelActive) {
        children = this.panelContent;
    } else {
        children = "Loading...";
    }
    return (
      <div className="panel panel-default">
        <div className="panel-heading">
            <h3 className="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href={"#" + panelID}
                   onClick={ () => this.setActivePanel(this.props.heading) }>
                  {this.props.heading}
                </a>
            </h3>
        </div>
        <div id={panelID} className={panelCollapseClasses}>
            <div className={panelBodyClasses}>
              {children}
            </div>
        </div>
      </div>
    );
  },

  setActivePanel: function(panel) {
    this.isDoneRenderingByDefault = true;
    this.props.setActivePanelCallback(panel);
  }
});

var DashboardPanelGroup = React.createClass({
  getInitialState: function() {
    return {activePanelName: "Stats"};
  },

  render: function() {
    return (
      <div className="panel-group" id="accordion">
        <Panel setActivePanelCallback={this.setActivePanelCallback}
               activePanelName={this.state.activePanelName}
               heading="Stats"
               noPanelPadding={true}
               isActiveByDefault={true}>
          <Stats hosts={this.props.hosts} />
        </Panel>
        <Panel heading="Allocations"
               setActivePanelCallback={this.setActivePanelCallback}
               activePanelName={this.state.activePanelName}>
          <Allocations allocations={this.props.allocations} hosts={this.props.hosts} />
        </Panel>
        <Panel heading="Pools"
               setActivePanelCallback={this.setActivePanelCallback}
               activePanelName={this.state.activePanelName}>
          <Pools hosts={this.props.hosts} />
        </Panel>
        <Panel heading="Diagnostics"
               setActivePanelCallback={this.setActivePanelCallback}
               activePanelName={this.state.activePanelName}>
          <Diagnostics hosts={this.props.hosts} />
        </Panel>
        <Panel heading="Legend"
               setActivePanelCallback={this.setActivePanelCallback}
               activePanelName={this.state.activePanelName}>
            <StatesLegend />
        </Panel>
      </div>
    );
  },

  setActivePanelCallback: function(panel) {
    this.setState({activePanelName: panel});
  }
});

var EmptyHostSlot = React.createClass({
  render: function() {
    return (
      <td className="host machine">
        <span className="label-default-light label machine-label">
          <span className="glyphicon glyphicon-ban-circle"></span>
          {pad(this.props.hostIdx)}
        </span>
      </td>
    );
  }
});

var DashboardNav = React.createClass({
  render: function() {
    return (
    <nav className="container navbar navbar-default">
      <ul className="nav navbar-nav">
    {% for dashboardSource in dashboardSources %}
        <li id="navButton_{{ dashboardSource.name }}">
          <a href="#" onClick={ () => this.props.changeDashboardSourceCallback('{{ dashboardSource.name }}') } >
            {{ dashboardSource.name }}
          </a>
        </li>
    {% endfor %}
      </ul>
    </nav> );
  },
});

var initialState = {hosts: [], allocations: []}
var Dashboard = React.createClass({
  render: function() {
    var dashboardContent;
    if (this.state.loadState == "LOADING") {
      dashboardContent = <div className="col-md-6">Loading...</div>;
    } else if (this.state.loadState == "DONE") {
      dashboardContent = <DashboardContent allocations={this.state.allocations} hosts={this.state.hosts} />;
    }
    return (
      <div>
        <DashboardNav changeDashboardSourceCallback={this.loadDashboard} />
        {dashboardContent}
      </div>
    );
  },

  getInitialState: function() {
    return {loadState: "LOADING"};
  },

  newStateCallback: function(state) {
    if (state === null) {
      this.forceUpdate();
      return;
    }
    this.setState({loadState: "DONE", hosts: state["hosts"], allocations: state["allocations"]});
  },

  changeStateToLoading: function(loadState, hosts) {
    this.setState({loadState: "LOADING"});
  },

  loadDashboard: function(dashboardName) {
    this.changeStateToLoading();
    if (activeDashboardName != "") {
        document.getElementById("navButton_" + activeDashboardName).className = "";
        ui.unregister("status_" + activeDashboardName, this.newStateCallback);
    }
    activeDashboardName = "";
    _.each(rackattackInstances, function(instance) {
      if (instance["name"] == dashboardName) {
        activeDashboardHost = instance["host"];
        return;
      }
    }); ui.register("status_" + dashboardName, this.newStateCallback);
    activeDashboardName = dashboardName;
    window.history.pushState("", dashboardName, "/" + dashboardName);
    document.getElementById("navButton_" + dashboardName).className = "active";
  },

  componentDidMount: function() {
    this.loadDefaultDashboard();
  },

  loadDefaultDashboard: function() {
    var defaultDashboard = "{{ defaultDashboard }}";
    if (!defaultDashboard) {
        defaultDashboard = rackattackInstances[0]["name"];
    }
    this.loadDashboard(defaultDashboard);
  }
});

ReactDOM.render(
  <Dashboard />,
  document.getElementById('content')
);
</script>

<main class="container" id="content"></main>

{% endblock %}
