{% extends "dashboardbase.html" %}

{% block content %}
<link href="/static/style.css" rel="stylesheet">

<div class="container">
    <div class="row">
        <div class="col-md-6">
            <h3>Hosts</h3>
            {% block rack %}{% endblock %}
            <div>
                <h4>Legend</h4>
                <p><span class="glyphicon glyphicon-backward"></span> QUICK_RECLAIMATION_IN_PROGRESS</p>
                <p>Quick reclaim works using kexecing the inaugurator on the host<p>
                <p><span class="glyphicon glyphicon-fast-backward"></span> SLOW_RECLAIMATION_IN_PROGRESS</p>
                <p>
                    Slow reclaim works by rebooting the server and using PXE to load the inaugurator.
                    This is slow since a server takes minutes to reboot, plus, more than one reboot
                    might be required.
                </p>
                <p><span class="glyphicon glyphicon-pause"></span> CHECKED_IN</p>
                <p>
                    The inaugurator has booted successfully, and is waiting for the command to switch
                    a rootfs. The current rootfs is being hashed in the background.
                </p>
                <p><span class="glyphicon glyphicon-play"></span> INAUGURATION_LABEL_PROVIDED</p>
                <p>
                    The inaugurator is replacing the rootfs in this host.
                </p>
                <p><span class="glyphicon glyphicon-ok"></span> INAUGURATION_DONE</p>
                <p>
                    The inaugurator has finished replacing the rootfs. This host was kexeced into
                    its image, which if not hung, means the test itself is running.
                </p>
                <p><span class="glyphicon glyphicon-remove"></span> DESTROYED</p>
                <p>
                    A temporary stage, on the road for the host to drop out of the cluster. This
                    happens if 5 slow reclamations failed on this host
                </p>
            </div>
        </div>
        <div class="col-md-6">
            <h3>Allocations <span class="badge" data-bind="text: allocations.allocations().length"> </span></h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Allocation</th>
                        <th>State</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: allocations.allocations">
                    <tr data-bind="attr: { allocationIndex: index }, event: { mouseover: mouseOver, mouseout: mouseOut }">
                        <td>
                            <div class="media">
                                <a class="media-left pull-left" href="#">
                                    <div class="color-swatch" data-bind="text: countHosts(), style: { backgroundColor: color }"></div>
                                </a>
                                <div class="media-body">
                                    <div class="media-heading" data-bind="text: info.user"> </div>
                                    <span class="hosts-list" data-bind="text: listHosts()"></span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="label label-danger" data-bind="if: dead()"> DEAD </span>
                            <span class="label label-primary" data-bind="if: ! dead() && done()"> DONE </span>
                            <span class="label label-warning" data-bind="if: ! dead() && ! done()"> WAIT </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script type="text/javascript" src="/realtimewebui/externals/underscore-min.js"></script>
<script type="text/javascript" src="/realtimewebui/externals/knockout-3.1.0.js"></script>
<script type="text/javascript" src="/realtimewebui/js/realtimewebui.js"></script>
<script>
var allocationColors = ["rgb(204, 221, 221)", "rgb(187, 221, 221)", "rgb(204, 238, 238)", "rgb(187, 221, 238)", "rgb(221, 238, 221)", "rgb(221, 238, 238)", "rgb(204, 238, 221)", "rgb(221, 238, 255)", "rgb(187, 221, 204)", "rgb(204, 238, 255)", "rgb(187, 238, 238)", "rgb(204, 204, 221)", "rgb(238, 221, 255)", "rgb(204, 221, 187)", "rgb(170, 221, 221)", "rgb(187, 238, 255)", "rgb(204, 221, 238)", "rgb(187, 238, 221)", "rgb(170, 221, 238)", "rgb(187, 221, 255)", "rgb(221, 238, 204)", "rgb(255, 238, 238)", "rgb(221, 204, 238)", "rgb(238, 238, 204)", "rgb(170, 238, 238)", "rgb(187, 204, 221)", "rgb(204, 238, 204)", "rgb(238, 204, 238)", "rgb(170, 238, 255)", "rgb(170, 221, 204)", "rgb(255, 221, 255)", "rgb(255, 238, 255)", "rgb(187, 204, 204)", "rgb(204, 204, 238)", "rgb(187, 221, 187)", "rgb(170, 221, 255)", "rgb(170, 238, 221)", "rgb(187, 204, 187)", "rgb(187, 238, 204)", "rgb(221, 204, 170)", "rgb(153, 221, 238)", "rgb(238, 204, 170)", "rgb(153, 221, 221)", "rgb(255, 238, 204)", "rgb(221, 221, 170)", "rgb(153, 238, 238)", "rgb(153, 238, 255)", "rgb(187, 204, 238)", "rgb(204, 204, 170)", "rgb(204, 221, 204)", "rgb(170, 204, 204)", "rgb(170, 204, 221)", "rgb(204, 221, 170)", "rgb(255, 204, 170)", "rgb(153, 221, 255)", "rgb(221, 238, 187)", "rgb(153, 238, 221)", "rgb(170, 238, 204)", "rgb(221, 221, 238)", "rgb(170, 221, 187)", "rgb(204, 238, 187)", "rgb(221, 204, 255)", "rgb(238, 204, 255)", "rgb(153, 221, 204)", "rgb(238, 238, 187)", "rgb(221, 255, 255)", "rgb(136, 238, 255)", "rgb(136, 238, 238)", "rgb(204, 255, 255)", "rgb(221, 255, 238)", "rgb(204, 204, 255)", "rgb(136, 221, 238)", "rgb(204, 255, 238)", "rgb(187, 238, 187)", "rgb(187, 221, 170)", "rgb(238, 255, 238)", "rgb(221, 187, 187)", "rgb(136, 221, 221)", "rgb(238, 187, 204)", "rgb(238, 187, 187)", "rgb(170, 204, 187)", "rgb(187, 255, 255)", "rgb(170, 204, 238)", "rgb(221, 187, 204)", "rgb(136, 238, 221)", "rgb(136, 221, 255)", "rgb(153, 238, 204)", "rgb(187, 204, 170)", "rgb(119, 238, 255)", "rgb(255, 238, 187)", "rgb(255, 187, 204)", "rgb(238, 255, 255)", "rgb(187, 255, 238)", "rgb(238, 204, 153)", "rgb(119, 238, 238)", "rgb(255, 187, 187)", "rgb(187, 204, 255)", "rgb(221, 221, 153)", "rgb(221, 204, 153)", "rgb(170, 255, 255)", "rgb(170, 238, 187)", "rgb(255, 204, 153)", "rgb(204, 187, 204)", "rgb(221, 255, 221)", "rgb(153, 221, 187)", "rgb(238, 187, 221)", "rgb(153, 204, 221)", "rgb(255, 187, 221)", "rgb(204, 255, 221)", "rgb(136, 221, 204)", "rgb(170, 255, 238)", "rgb(221, 238, 170)", "rgb(102, 238, 255)", "rgb(153, 204, 204)", "rgb(238, 187, 170)", "rgb(204, 221, 153)", "rgb(119, 221, 238)", "rgb(204, 238, 170)", "rgb(221, 187, 170)", "rgb(119, 238, 221)", "rgb(204, 187, 187)", "rgb(255, 221, 153)", "rgb(255, 255, 238)", "rgb(238, 255, 221)", "rgb(170, 221, 170)", "rgb(238, 238, 255)", "rgb(221, 187, 221)", "rgb(136, 238, 204)", "rgb(153, 255, 255)", "rgb(102, 238, 238)", "rgb(119, 221, 255)", "rgb(238, 238, 170)", "rgb(221, 221, 204)", "rgb(187, 255, 221)", "rgb(255, 187, 170)", "rgb(204, 204, 153)", "rgb(204, 221, 255)", "rgb(119, 221, 221)", "rgb(187, 238, 170)", "rgb(153, 238, 187)"];

function setStatus(statusObject)
{
    if (!statusObject)
        return;
    updateHosts(statusObject);
    model.allocations.update(statusObject);
}

var hostsByIndex = {};

function updateHosts(statusObject)
{
    for (var i in statusObject.hosts) {
        var hostObject = statusObject.hosts[i];
        hostsByIndex[hostObject.index] = hostObject.id;
        var j = $("#node-"+hostObject.id);
        var stateHtml;
        if (hostObject.state == "QUICK_RECLAIMATION_IN_PROGRESS")
            stateHtml = '<span class="glyphicon glyphicon-backward">';
        else if (hostObject.state == "SLOW_RECLAIMATION_IN_PROGRESS")
            stateHtml = '<span class="glyphicon glyphicon-fast-backward">';
        else if (hostObject.state == "CHECKED_IN")
            stateHtml = '<span class="glyphicon glyphicon-pause">';
        else if (hostObject.state == "INAUGURATION_LABEL_PROVIDED")
            stateHtml = '<span class="glyphicon glyphicon-play">';
        else if (hostObject.state == "INAUGURATION_DONE")
            stateHtml = '<span class="glyphicon glyphicon-ok">';
        else if (hostObject.state == "DESTROYED")
            stateHtml = '<span class="glyphicon glyphicon-remove">';
        else
            stateHtml = "NA";
        j.html(stateHtml + " " + hostObject.id).addClass("machine-idle");
    }
}

function Allocation(allocationStatus, color) {
    var self = this;
    self.index = allocationStatus.index;
    self.info = allocationStatus.allocationInfo;
    self.allocated = allocationStatus.allocated;
    self.done = ko.observable(allocationStatus.done);
    self.dead = ko.observable(allocationStatus.dead);
    self.color = color;

    self.update = function(allocationStatus) {
        self.done(allocationStatus.done);
        self.dead(allocationStatus.dead);
    };

    self.applyClasses = function () {
        if (self.dead())
            return;
        for (var k in self.allocated) {
            var index = self.allocated[k];
            var id = hostsByIndex[index];
            var j = $("#node-" + id);
            j.removeClass('machine-idle').css({ backgroundColor: self.color });
        }
    };

    self.countHosts = function() {
        return Object.keys(self.allocated).length;
    };

    self.listHosts = function () {
        var indices = _.values(self.allocated);
        return _.map(indices, function(index) { return hostsByIndex[index]}).sort().join(", ")
    };

    self.mouseOver = function () {
        if (self.dead())
            return;
        for (var k in self.allocated) {
            var index = self.allocated[k];
            var id = hostsByIndex[index];
            var j = $("#node-" + id);
            j.addClass("node-when-allocation-is-hovered");
        }
    };

    self.mouseOut = function() {
        if (self.dead())
            return;
        for (var k in self.allocated) {
            var index = self.allocated[k];
            var id = hostsByIndex[index];
            var j = $("#node-" + id);
            j.removeClass("node-when-allocation-is-hovered");
        }
    }
}

function AllocationsModel() {
    var self = this;
    self.allocations = ko.observableArray([]);

    self._freeColor = function()
    {
        var used = _.pluck(self.allocations(), 'color');
        return _.difference(allocationColors, used)[0];
    };

    self.update = function(statusObject)
    {
        var allocationIndices = {};
        for (var i in statusObject.allocations) {
            var allocation = statusObject.allocations[i];
            allocationIndices[allocation.index] = true;
            if (!_.contains(_.pluck(self.allocations(), 'index'), allocation.index)) {
                if (!allocation.dead)
                    self.allocations.push(new Allocation(allocation, self._freeColor()));
            }
            var model = _.find(self.allocations(), function(a) { return a.index == allocation.index });
            if (allocation.dead)
                self.allocations.remove(model);
            else {
                model.update(allocation);
                model.applyClasses();
            }
        }
        var copy = new Array(self.allocations());
        for (var i in copy) {
            var model = copy[i];
            if (!_.contains(_.pluck(statusObject.allocations, 'index'), model.index))
                self.allocations.remove(model);
        }
    };
}

function Model() {
    var self = this;
    self.allocations = new AllocationsModel();

    self._findAllocation = function(obj) {
        var allocationIndex = obj.getAttribute('allocationIndex');
        for (var i in self.allocations.allocations()) {
            var allocation = self.allocations.allocations()[i];
            if (allocationIndex == "" + allocation.index) {
                return allocation;
            }
        }
        console.log("No such allocation");
        return undefined;
    };
}

var model = new Model();
ko.applyBindings(model);

var ui = new RealTimeWebUI();
ui.register("status", setStatus);
</script>

{% endblock %}
