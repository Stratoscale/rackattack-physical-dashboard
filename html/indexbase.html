{% extends "dashboardbase.html" %}

{% block content %}
<link href="/static/style.css" rel="stylesheet">

<div class="container">
    <div class="row">
        <div class="col-md-6">
            <h3>Hosts</h3>
            {% block rack %}{% endblock %}
            <p></p>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Legend</h3>
                </div>
                <div class="panel-body">
                    <p><span class="glyphicon glyphicon-backward"></span> QUICK_RECLAIMATION_IN_PROGRESS</p>
                    <p>Quick reclaim works using kexecing the inaugurator on the host
                    <p>
                    <p><span class="glyphicon glyphicon-fast-backward"></span> SLOW_RECLAIMATION_IN_PROGRESS</p>
                    <p>
                        Slow reclaim works by rebooting the server and using PXE to load the inaugurator.
                        This is slow since a server takes minutes to reboot, plus, more than one reboot
                        might be required.
                    </p>
                    <p><span class="glyphicon glyphicon-pause"></span> CHECKED_IN</p>
                    <p>
                        The inaugurator has booted successfully, and is waiting for the command to switch
                        a rootfs. The current rootfs is being hashed in the background.
                    </p>
                    <p><span class="glyphicon glyphicon-play"></span> INAUGURATION_LABEL_PROVIDED</p>
                    <p>
                        The inaugurator is replacing the rootfs in this host.
                    </p>
                    <p><span class="glyphicon glyphicon-ok"></span> INAUGURATION_DONE</p>
                    <p>
                        The inaugurator has finished replacing the rootfs. This host was kexeced into
                        its image, which if not hung, means the test itself is running.
                    </p>
                    <p><span class="glyphicon glyphicon-remove"></span> DESTROYED</p>
                    <p>
                        A temporary stage, on the road for the host to drop out of the cluster. This
                        happens if 5 slow reclamations failed on this host
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <h3>Allocations <span class="badge" data-bind="text: allocations.allocations().length"> </span></h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Allocation</th>
                        <th>State</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: allocations.allocations">
                    <tr data-bind="attr: { allocationIndex: index }, event: { mouseover: mouseOver, mouseout: mouseOut }" class="allocation-row">
                        <td>
                            <div class="media">
                                <a class="media-left pull-left" href="#">
                                    <div class="color-swatch" data-bind="text: countHosts(), style: { backgroundColor: color }"></div>
                                </a>
                                <div class="media-body">
                                    <div class="media-heading" data-bind="text: info.user"> </div>
                                    <span class="hosts-list" data-bind="text: listHosts()"></span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="label label-danger" data-bind="if: dead()"> DEAD </span>
                            <span class="label label-success" data-bind="if: ! dead() && done()"> DONE </span>
                            <span class="label label-primary" data-bind="if: ! dead() && ! done()"> WAIT </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/html" id="machine-template">
    <span class="label <%= config.labelClass %>" title="<%= serverName %>">
        <span class="glyphicon <%= config.iconClass %>"></span>
        <%= serverName  %>
    </span>

</script>

<script type="text/javascript" src="/realtimewebui/externals/underscore-min.js"></script>
<script type="text/javascript" src="/realtimewebui/externals/knockout-3.1.0.js"></script>
<script type="text/javascript" src="/realtimewebui/js/realtimewebui.js"></script>

<script>
var allocationColors = ["#f44336","#f44336","#e53935","#d32f2f","#c62828","#b71c1c","#e91e63","#e91e63","#d81b60","#c2185b","#ad1457","#880e4f","#9c27b0","#ba68c8","#ab47bc","#9c27b0","#8e24aa","#7b1fa2","#6a1b9a","#4a148c","#673ab7","#9575cd","#7e57c2","#673ab7","#5e35b1","#512da8","#4527a0","#311b92","#3f51b5","#7986cb","#5c6bc0","#3f51b5","#3949ab","#303f9f","#283593","#1a237e","#2196f3","#2196f3","#1e88e5","#1976d2","#1565c0","#0d47a1","#03a9f4","#03a9f4","#039be5","#0288d1","#0277bd","#01579b","#00bcd4","#00bcd4","#00acc1","#0097a7","#00838f","#006064","#009688","#009688","#00897b","#00796b","#00695c","#004d40","#4caf50","#4caf50","#43a047","#388e3c","#2e7d32","#1b5e20","#8bc34a","#8bc34a","#7cb342","#689f38","#558b2f","#33691e","#cddc39","#afb42b","#9e9d24","#827717","#ffeb3b","#f57f17","#ffc107","#ffa000","#ff8f00","#ff6f00","#ff9800","#ff9800","#fb8c00","#f57c00","#ef6c00","#e65100","#ff5722","#ff5722","#f4511e","#e64a19","#d84315","#bf360c","#795548","#a1887f","#8d6e63","#795548","#6d4c41","#5d4037","#4e342e","#3e2723","#9e9e9e","#9e9e9e","#757575","#616161","#424242","#212121","#607d8b","#78909c","#607d8b","#546e7a","#455a64","#37474f","#263238"];

function setStatus(statusObject)
{
    if (!statusObject)
        return;
    updateHosts(statusObject);
    model.allocations.update(statusObject);
}

var hostsByIndex = {};
var stateMap = {
    "QUICK_RECLAIMATION_IN_PROGRESS":{ iconClass: "glyphicon-backward", labelClass: "label-info" },
    "SLOW_RECLAIMATION_IN_PROGRESS":{ iconClass: "glyphicon-fast-backward", labelClass: "label-warning" },
    "CHECKED_IN":{ iconClass: "glyphicon-pause", labelClass: "label-primary" },
    "INAUGURATION_LABEL_PROVIDED":{ iconClass: "glyphicon-play", labelClass: "label-primary" },
    "INAUGURATION_DONE":{ iconClass: "glyphicon-ok", labelClass: "label-success" },
    "DESTROYED":{ iconClass: "glyphicon-remove", labelClass: "label-danger" }
};

function updateHosts(statusObject)
{
    var template = _.template( $("#machine-template").html() );
    $(".machine").popover('destroy').each(function() {
        var serverName = $(this).attr("id").replace(/node-rack\d+-/, "");
        $(this).html(template({
            serverName: serverName,
            config: {
                iconClass: "glyphicon-ban-circle",
                labelClass: "label-default"
            }
        }))
    });

    for (var i in statusObject.hosts) {
        var hostObject = statusObject.hosts[i];
        var serverName = hostObject.id.replace(/rack\d+-/, "");
        hostsByIndex[hostObject.index] = hostObject.id;
        var node = $("#node-" + hostObject.id);
        var data = {
            serverName: serverName,
            config: stateMap[hostObject.state]
        };

        node.html(template(data));
        node.popover({
            title: serverName,
            container: "body",
            content: hostObject.ipAddress,
            trigger: "hover",
            placement: "auto"
        })

    }
}

function Allocation(allocationStatus, color) {
    var self = this;
    self.index = allocationStatus.index;
    self.info = allocationStatus.allocationInfo;
    self.allocated = allocationStatus.allocated;
    self.done = ko.observable(allocationStatus.done);
    self.dead = ko.observable(allocationStatus.dead);
    self.color = color;

    self.update = function(allocationStatus) {
        self.done(allocationStatus.done);
        self.dead(allocationStatus.dead);
    };

    self.applyClasses = function () {
        if (self.dead())
            return;
        for (var k in self.allocated) {
            var index = self.allocated[k];
            var id = hostsByIndex[index];
            var elem = $("#node-" + id);
            elem.removeClass('machine-idle').find(".color-swatch").css({ backgroundColor: self.color });
        }
    };

    self.countHosts = function() {
        return Object.keys(self.allocated).length;
    };

    self.listHosts = function () {
        var indices = _.values(self.allocated);
        return _.map(indices, function(index) { return hostsByIndex[index]}).sort().join(", ")
    };

    self.mouseOver = function () {
        if (self.dead())
            return;
        for (var k in self.allocated) {
            var index = self.allocated[k];
            var id = hostsByIndex[index];
            var elem = $("#node-" + id);
            elem.css({"border-color": self.color, "border-width": "2px"}).addClass("node-when-allocation-is-hovered");
        }
    };

    self.mouseOut = function() {
        if (self.dead())
            return;
        for (var k in self.allocated) {
            var index = self.allocated[k];
            var id = hostsByIndex[index];
            var elem = $("#node-" + id);
            elem.css({"border-color": "", "border-width": ""}).removeClass("node-when-allocation-is-hovered");
        }
    }
}

function AllocationsModel() {
    var self = this;
    self.allocations = ko.observableArray([]);

    self._freeColor = function()
    {
        var used = _.pluck(self.allocations(), 'color');
        return _.difference(allocationColors, used)[0];
    };

    self.update = function(statusObject)
    {
        var allocationIndices = {};
        for (var i in statusObject.allocations) {
            var allocation = statusObject.allocations[i];
            allocationIndices[allocation.index] = true;
            if (!_.contains(_.pluck(self.allocations(), 'index'), allocation.index)) {
                if (!allocation.dead)
                    self.allocations.push(new Allocation(allocation, self._freeColor()));
            }
            var model = _.find(self.allocations(), function(a) { return a.index == allocation.index });
            if (allocation.dead)
                self.allocations.remove(model);
            else {
                model.update(allocation);
                model.applyClasses();
            }
        }
        var copy = new Array(self.allocations());
        for (var i in copy) {
            var model = copy[i];
            if (!_.contains(_.pluck(statusObject.allocations, 'index'), model.index))
                self.allocations.remove(model);
        }
    };
}

function Model() {
    var self = this;
    self.allocations = new AllocationsModel();

    self._findAllocation = function(obj) {
        var allocationIndex = obj.getAttribute('allocationIndex');
        for (var i in self.allocations.allocations()) {
            var allocation = self.allocations.allocations()[i];
            if (allocationIndex == "" + allocation.index) {
                return allocation;
            }
        }
        console.log("No such allocation");
        return undefined;
    };
}

var model = new Model();
ko.applyBindings(model);

var ui = new RealTimeWebUI();
ui.register("status", setStatus);
</script>

{% endblock %}
